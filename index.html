<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÉBANO DISEÑO & CONSTRUCCION</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Montserrat & Lato -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Montserrat:wght@700;900&display=swap" rel="stylesheet">
    
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- Three.js for 3D Models -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.164.1/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.164.1/examples/jsm/",
                "lil-gui": "https://cdn.jsdelivr.net/npm/lil-gui@0.19.2/dist/lil-gui.esm.js"
            }
        }
    </script>

    <style>
        body {
            font-family: 'Lato', sans-serif;
            background-color: #f4f4f5; /* Zinc 100 */
        }
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Montserrat', sans-serif;
        }
        .hero-section {
            background-image: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url('https://images.unsplash.com/photo-1582268611958-ebfd161ef9cf?q=80&w=2070&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
        }
        .section-title {
            font-weight: 900;
            color: #18181b; /* Zinc 900 */
        }
        .sticky-nav {
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 50;
            transition: background-color 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
        }
        .nav-link {
            position: relative;
            transition: color 0.3s;
        }
        .nav-link::after {
            content: '';
            position: absolute;
            width: 0;
            height: 2px;
            bottom: -4px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #facc15; /* Yellow 400 */
            transition: width 0.3s;
        }
        .nav-link.active, .nav-link:hover {
            color: #facc15; /* Yellow 400 */
        }
        .nav-link.active::after, .nav-link:hover::after {
            width: 100%;
        }
        #viewer-3d-container {
            width: 100%;
            height: 500px;
            background-color: #e4e4e7; /* Zinc 200 */
            border-radius: 0.5rem;
            cursor: grab;
            position: relative;
        }
        #viewer-3d-container:active {
            cursor: grabbing;
        }
        #viewer-3d-loader {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #52525b; /* Zinc 600 */
            font-size: 1.2rem;
            display: none; /* Hidden by default */
        }
        .thumbnail {
            cursor: pointer;
            transition: transform 0.2s, border-color 0.2s;
            border: 2px solid transparent;
        }
        .thumbnail:hover {
            transform: scale(1.05);
        }
        .thumbnail.active {
            border-color: #facc15; /* Yellow 400 */
        }
        .fade-out {
            opacity: 0;
        }
        .fade-in {
            opacity: 1;
        }
        #main-project-image {
            transition: opacity 0.3s ease-in-out;
        }
        .project-nav-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #d4d4d8; /* Zinc 300 */
            transition: background-color 0.3s;
            cursor: pointer;
        }
        .project-nav-dot.active {
            background-color: #18181b; /* Zinc 900 */
        }
        .plan-card-vertical .reveal-item {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.6s ease-out, transform 0.6s ease-out;
        }
        .plan-card-vertical.is-visible .reveal-item {
            opacity: 1;
            transform: translateY(0);
        }
        .plan-card-vertical.is-visible .reveal-item:nth-child(2) { transition-delay: 0.1s; }
        .plan-card-vertical.is-visible .reveal-item:nth-child(3) { transition-delay: 0.2s; }
        .plan-card-vertical.is-visible .reveal-item:nth-child(4) { transition-delay: 0.3s; }
        .plan-card-vertical.is-visible .reveal-item:nth-child(5) { transition-delay: 0.4s; }

        /* Fullscreen Modal Styles */
        #fullscreen-modal {
            transition: opacity 0.3s ease-in-out;
        }
        #modal-viewer-container {
            width: 100%;
            height: 100%;
        }

    </style>
</head>
<body class="bg-zinc-100 text-zinc-800">

    <!-- Sticky Header -->
    <header id="main-header" class="sticky-nav bg-zinc-900/80 backdrop-blur-sm shadow-lg">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="#" class="text-2xl font-bold text-white">ÉBANO</a>
            <div class="hidden md:flex items-center space-x-8">
                <a href="#propuesta" class="nav-link text-white font-semibold">Propuesta</a>
                <a href="#planes" class="nav-link text-white font-semibold">Planes</a>
                <a href="#portafolio" class="nav-link text-white font-semibold">Portafolio 3D</a>
                <a href="#contacto" class="nav-link text-white font-semibold">Contacto</a>
            </div>
        </nav>
    </header>

    <!-- Main Content -->
    <main>
        <!-- Hero Section -->
        <section class="hero-section h-screen flex items-center justify-center text-center text-white pt-16">
            <div>
                <h1 class="text-5xl md:text-7xl font-black mb-4 leading-tight">PROYECTAMOS TU CASA IDEAL</h1>
                <p class="text-lg md:text-xl max-w-3xl mx-auto mb-8">Diseñamos los espacios que necesitas para mejorar tu calidad de vida.</p>
                <a href="#propuesta" class="bg-yellow-400 text-zinc-900 font-bold py-3 px-8 rounded-full uppercase tracking-wider hover:bg-yellow-300 transition-colors duration-300">Conoce Más</a>
            </div>
        </section>

        <section id="propuesta" class="py-24 bg-white">
            <div class="container mx-auto px-6 text-center">
                <h2 class="section-title text-4xl mb-6">¿Pensando en ampliar o remodelar?</h2>
                <p class="max-w-3xl mx-auto text-lg text-zinc-600 mb-12">
                    Te ofrecemos una idea clara y la documentación necesaria para que tu proyecto se convierta en una guía sólida a la hora de construir.
                </p>
                <img src="https://images.unsplash.com/photo-1487958449943-2429e8be8625?q=80&w=2070&auto=format&fit=crop" alt="Plano arquitectónico" class="rounded-lg shadow-2xl max-w-full md:max-w-4xl mx-auto">
            </div>
        </section>

        <section id="planes" class="py-24">
            <div class="container mx-auto px-6">
                <div class="text-center mb-16">
                    <h2 class="section-title text-4xl mb-4">Planes y Servicios</h2>
                    <p class="text-lg text-zinc-600">Elige el plan que mejor se adapte a tus necesidades.</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    <!-- Plan Básico -->
                    <div class="plan-card-vertical bg-white rounded-lg shadow-lg p-8 flex flex-col text-center border-t-4 border-zinc-800">
                        <div class="reveal-item">
                            <h3 class="text-2xl font-bold mb-4">Plan Básico</h3>
                            <p class="text-zinc-600 mb-8 h-24">Ideal para tener una visión clara del proyecto con la documentación esencial.</p>
                        </div>
                        <ul class="text-left space-y-4 mb-8 flex-grow">
                            <li class="reveal-item flex items-center"><i class="fas fa-check-circle text-zinc-800 mr-3"></i> Memoria descriptiva</li>
                            <li class="reveal-item flex items-center"><i class="fas fa-check-circle text-zinc-800 mr-3"></i> Plano de Arquitectura</li>
                        </ul>
                        <div class="reveal-item">
                            <p class="text-4xl font-extrabold text-zinc-900 mb-2">$60.000</p>
                            <p class="text-zinc-500 text-sm">(Hasta 50 m²)</p>
                        </div>
                    </div>
                    <!-- Plan Intermedio -->
                    <div class="plan-card-vertical bg-zinc-800 text-white rounded-lg shadow-2xl p-8 flex flex-col text-center transform scale-105 border-t-4 border-yellow-400">
                         <div class="reveal-item">
                            <h3 class="text-2xl font-bold mb-4">Plan Intermedio</h3>
                            <p class="text-zinc-300 mb-8 h-24">Perfecto para visualizar tu proyecto en 3D y entender mejor los volúmenes.</p>
                        </div>
                        <ul class="text-left space-y-4 mb-8 flex-grow">
                            <li class="reveal-item flex items-center"><i class="fas fa-check-circle text-yellow-400 mr-3"></i> Todo lo del Plan Básico</li>
                            <li class="reveal-item flex items-center"><i class="fas fa-plus-circle text-yellow-400 mr-3"></i> Imágenes 3D conceptuales</li>
                        </ul>
                        <div class="reveal-item">
                            <p class="text-4xl font-extrabold text-white mb-2">$120.000</p>
                            <p class="text-zinc-400 text-sm">(Hasta 50 m²)</p>
                        </div>
                    </div>
                    <!-- Plan Completo -->
                    <div class="plan-card-vertical bg-white rounded-lg shadow-lg p-8 flex flex-col text-center border-t-4 border-zinc-800">
                         <div class="reveal-item">
                            <h3 class="text-2xl font-bold mb-4">Plan Completo</h3>
                            <p class="text-zinc-600 mb-8 h-24">La solución integral con toda la documentación técnica y visual que necesitas.</p>
                        </div>
                        <ul class="text-left space-y-4 mb-8 flex-grow">
                            <li class="reveal-item flex items-center"><i class="fas fa-check-circle text-zinc-800 mr-3"></i> Todo lo del Plan Intermedio</li>
                            <li class="reveal-item flex items-center"><i class="fas fa-plus-circle text-zinc-800 mr-3"></i> Planos de Estructuras</li>
                             <li class="reveal-item flex items-center"><i class="fas fa-plus-circle text-zinc-800 mr-3"></i> Imágenes 3D detalladas</li>
                        </ul>
                        <div class="reveal-item">
                            <p class="text-4xl font-extrabold text-zinc-900 mb-2">Desde $250.000</p>
                            <p class="text-zinc-500 text-sm">(Hasta 50 m²)</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="portafolio" class="py-24 bg-white">
            <div class="container mx-auto px-6">
                <!-- Header -->
                <div class="text-center mb-12">
                    <h2 class="section-title text-4xl mb-4">Portafolio Interactivo</h2>
                    <p class="text-lg text-zinc-600 max-w-3xl mx-auto">Explora nuestros proyectos. Usa el ratón en el visor 3D para rotar y hacer zoom.</p>
                </div>

                <!-- Project Title, Description & Top Navigation -->
                <div id="project-header" class="relative max-w-4xl mx-auto text-center mb-12 transition-opacity duration-300">
                    <h3 id="project-title" class="text-3xl font-bold text-zinc-900 mb-2"></h3>
                    <p id="project-description" class="text-zinc-600 max-w-2xl mx-auto"></p>
                    <button class="project-nav-btn prev-btn absolute left-0 -top-2 md:top-1/2 md:-translate-y-1/2 bg-white hover:bg-zinc-100 p-2 rounded-full shadow-md transition-colors w-10 h-10 flex items-center justify-center">
                        <i class="fas fa-chevron-left text-zinc-800"></i>
                    </button>
                    <button class="project-nav-btn next-btn absolute right-0 -top-2 md:top-1/2 md:-translate-y-1/2 bg-white hover:bg-zinc-100 p-2 rounded-full shadow-md transition-colors w-10 h-10 flex items-center justify-center">
                        <i class="fas fa-chevron-right text-zinc-800"></i>
                    </button>
                </div>

                <!-- Gallery & 3D Viewer Grid -->
                <div id="portfolio-content-grid" class="grid grid-cols-1 lg:grid-cols-2 gap-12 items-center">
                    <!-- Image Gallery Column -->
                    <div id="project-gallery" class="transition-opacity duration-300 relative">
                        <img id="main-project-image" src="" alt="Imagen principal del proyecto" class="w-full h-96 object-cover rounded-lg shadow-lg mb-4">
                        <button class="image-nav-btn prev-img-btn absolute top-1/2 -translate-y-1/2 left-4 bg-black/30 text-white rounded-full w-10 h-10 hover:bg-black/50 transition-colors"><i class="fas fa-chevron-left"></i></button>
                        <button class="image-nav-btn next-img-btn absolute top-1/2 -translate-y-1/2 right-4 bg-black/30 text-white rounded-full w-10 h-10 hover:bg-black/50 transition-colors"><i class="fas fa-chevron-right"></i></button>
                        <div id="project-thumbnails" class="grid grid-cols-5 gap-2">
                            <!-- Thumbnails will be generated here -->
                        </div>
                    </div>

                    <!-- 3D Viewer Column -->
                    <div id="viewer-wrapper" class="relative">
                         <div id="viewer-3d-container">
                            <div id="viewer-3d-loader">
                                <i class="fas fa-spinner fa-spin mr-2"></i> Cargando modelo...
                            </div>
                        </div>
                        <button id="fullscreen-btn" class="absolute top-4 right-4 bg-black/30 text-white rounded-full w-10 h-10 hover:bg-black/50 transition-colors z-10">
                            <i class="fas fa-expand"></i>
                        </button>
                    </div>
                </div>

                <!-- Bottom Navigation -->
                <div class="flex justify-center items-center space-x-4 mt-12">
                     <button class="project-nav-btn prev-btn bg-white hover:bg-zinc-100 p-2 rounded-full shadow-md transition-colors w-10 h-10 flex items-center justify-center">
                        <i class="fas fa-chevron-left text-zinc-800"></i>
                    </button>
                     <div id="project-dots" class="flex space-x-2"></div>
                     <button class="project-nav-btn next-btn bg-white hover:bg-zinc-100 p-2 rounded-full shadow-md transition-colors w-10 h-10 flex items-center justify-center">
                        <i class="fas fa-chevron-right text-zinc-800"></i>
                    </button>
                </div>
            </div>
        </section>

        <section id="contacto" class="py-24 bg-zinc-800 text-white">
            <div class="container mx-auto px-6 text-center">
                <h2 class="text-4xl font-bold mb-4">Empecemos a diseñar tu próximo proyecto</h2>
                <p class="text-lg text-zinc-300 mb-8">Escríbenos y demos el primer paso juntos.</p>
                <div class="flex flex-col md:flex-row items-center justify-center space-y-4 md:space-y-0 md:space-x-8">
                    <a href="https://wa.me/5493816649439" target="_blank" class="bg-yellow-400 text-zinc-900 font-bold py-4 px-8 rounded-full text-lg hover:bg-yellow-300 transition-colors duration-300 flex items-center">
                        <i class="fab fa-whatsapp mr-3"></i> 381-664-9439
                    </a>
                    <a href="https://www.instagram.com/EBANO.CONSTRUCCION" target="_blank" class="border-2 border-white text-white font-bold py-4 px-8 rounded-full text-lg hover:bg-white hover:text-zinc-900 transition-colors duration-300 flex items-center">
                        <i class="fab fa-instagram mr-3"></i> @EBANO.CONSTRUCCION
                    </a>
                </div>
            </div>
        </section>
    </main>

    <footer class="bg-zinc-900 text-zinc-400 py-6">
        <div class="container mx-auto px-6 text-center text-sm">
            <p>&copy; 2025 ÉBANO DISEÑO & CONSTRUCCION</p>
            <p class="mt-2">Santiago del Estero, Argentina</p>
        </div>
    </footer>

    <!-- Fullscreen Modal -->
    <div id="fullscreen-modal" class="fixed inset-0 bg-black/80 z-50 hidden items-center justify-center p-4">
        <div id="modal-viewer-container" class="relative w-full h-full"></div>
        <button id="close-modal-btn" class="absolute top-5 right-5 text-white text-3xl hover:text-yellow-400 transition-colors">
            <i class="fas fa-times"></i>
        </button>
    </div>


    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { RoomEnvironment } from 'three/addons/environments/RoomEnvironment.js';
        import { GUI } from 'lil-gui';

        // Obtener URL base del sitio actual
        const baseUrl = window.location.protocol + '//' + window.location.host;
        const basePath = window.location.pathname.split('/')[1] ? '/' + window.location.pathname.split('/')[1] : '';
        const url = baseUrl + basePath;

        // --- Portfolio Data ---
        const projects = [
            {
                title: 'Residencia Moderna',
                description: 'Un diseño contemporáneo que maximiza la luz natural y los espacios abiertos, creando un ambiente de lujo y confort.',
                images: [
                    'https://images.unsplash.com/photo-1568605114967-8130f3a36994?q=80&w=2070&auto=format&fit=crop',
                    'https://images.unsplash.com/photo-1600585154340-be6161a56a0c?q=80&w=2070&auto=format&fit=crop',
                    'https://images.unsplash.com/photo-1600607687939-ce8a6c25118c?q=80&w=2070&auto=format&fit=crop'
                ],
                modelUrl: url + '/projects/example/scene.gltf'
            },
            {
                title: 'Galería de Arte',
                description: 'Un espacio diseñado para exhibir arte, con iluminación profesional y un diseño que no compite con las obras.',
                images: [
                    'https://images.unsplash.com/photo-1575517111478-7f6afd0973db?q=80&w=2070&auto=format&fit=crop',
                    'https://images.unsplash.com/photo-1598228723793-52759bba239c?q=80&w=1974&auto=format&fit=crop'
                ],
                modelUrl: null
            },
            {
                title: 'Oficina Minimalista',
                description: 'Espacio de trabajo funcional y de diseño limpio, pensado para fomentar la creatividad y la productividad.',
                images: [
                    'https://images.unsplash.com/photo-1524758631624-e2822e304c36?q=80&w=2070&auto=format&fit=crop',
                    'https://images.unsplash.com/photo-1556761175-5973dc0f32e7?q=80&w=2232&auto=format&fit=crop',
                    'https://images.unsplash.com/photo-1552664730-d307ca884978?q=80&w=2070&auto=format&fit=crop'
                ],
                modelUrl: null
            }
        ];
        let currentProjectIndex = 0;
        let currentImageIndex = 0;

        // --- DOM Elements ---
        const projectHeader = document.getElementById('project-header');
        const projectGallery = document.getElementById('project-gallery');
        const portfolioGrid = document.getElementById('portfolio-content-grid');
        const viewerWrapper = document.getElementById('viewer-wrapper');
        const projectTitle = document.getElementById('project-title');
        const projectDescription = document.getElementById('project-description');
        const mainImage = document.getElementById('main-project-image');
        const thumbnailsContainer = document.getElementById('project-thumbnails');
        const projectDotsContainer = document.getElementById('project-dots');
        const allProjectNavBtns = document.querySelectorAll('.project-nav-btn');
        const prevImgBtn = document.querySelector('.prev-img-btn');
        const nextImgBtn = document.querySelector('.next-img-btn');
        const loader3D = document.getElementById('viewer-3d-loader');
        const fullscreenBtn = document.getElementById('fullscreen-btn');
        const modal = document.getElementById('fullscreen-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const modalViewerContainer = document.getElementById('modal-viewer-container');

        // --- Portfolio Logic ---
        function updatePortfolioView(index) {
            const project = projects[index];
            currentImageIndex = 0;

            projectHeader.classList.add('fade-out');
            projectGallery.classList.add('fade-out');
            viewerWrapper.classList.add('fade-out');

            setTimeout(() => {
                projectTitle.textContent = project.title;
                projectDescription.textContent = project.description;
                updateImageView(true); // Instant update for project change
                updateDots();

                if (project.modelUrl) {
                    fullscreenBtn.style.display = 'block';
                    viewerWrapper.style.display = 'block';
                    portfolioGrid.classList.remove('lg:grid-cols-1');
                    portfolioGrid.classList.add('lg:grid-cols-2');
                    loadModel(mainScene, project.modelUrl, (model) => { mainModel = model; });
                } else {
                    fullscreenBtn.style.display = 'none';
                    viewerWrapper.style.display = 'none';
                    portfolioGrid.classList.remove('lg:grid-cols-2');
                    portfolioGrid.classList.add('lg:grid-cols-1');
                    if(mainModel) mainScene.remove(mainModel);
                    mainModel = null;
                }

                projectHeader.classList.remove('fade-out');
                projectGallery.classList.remove('fade-out');
                viewerWrapper.classList.remove('fade-out');
            }, 300);
        }

        function updateImageView(isInstant = false) {
            const project = projects[currentProjectIndex];

            const update = () => {
                mainImage.src = project.images[currentImageIndex];
                thumbnailsContainer.innerHTML = '';
                project.images.forEach((imgSrc, i) => {
                    const thumb = document.createElement('img');
                    thumb.src = imgSrc;
                    thumb.className = 'thumbnail w-full h-20 object-cover rounded';
                    if (i === currentImageIndex) thumb.classList.add('active');
                    thumb.addEventListener('click', () => {
                        currentImageIndex = i;
                        updateImageView();
                    });
                    thumbnailsContainer.appendChild(thumb);
                });
                mainImage.classList.remove('fade-out');
            }

            if (isInstant) {
                update();
            } else {
                mainImage.classList.add('fade-out');
                setTimeout(update, 300);
            }
        }

        function updateDots() {
            projectDotsContainer.innerHTML = '';
            projects.forEach((_, i) => {
                const dot = document.createElement('div');
                dot.className = 'project-nav-dot';
                if (i === currentProjectIndex) dot.classList.add('active');
                dot.addEventListener('click', () => {
                    currentProjectIndex = i;
                    updatePortfolioView(currentProjectIndex);
                });
                projectDotsContainer.appendChild(dot);
            });
        }

        allProjectNavBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                if (btn.classList.contains('next-btn')) {
                    currentProjectIndex = (currentProjectIndex + 1) % projects.length;
                } else {
                    currentProjectIndex = (currentProjectIndex - 1 + projects.length) % projects.length;
                }
                updatePortfolioView(currentProjectIndex);
            });
        });

        nextImgBtn.addEventListener('click', () => {
             const project = projects[currentProjectIndex];
             currentImageIndex = (currentImageIndex + 1) % project.images.length;
             updateImageView();
        });
        prevImgBtn.addEventListener('click', () => {
             const project = projects[currentProjectIndex];
             currentImageIndex = (currentImageIndex - 1 + project.images.length) % project.images.length;
             updateImageView();
        });

        // --- Swipe Logic for Image Gallery ---
        let touchstartX = 0;
        let touchendX = 0;

        function handleGesture() {
            if (touchendX < touchstartX) { nextImgBtn.click(); }
            if (touchendX > touchstartX) { prevImgBtn.click(); }
        }

        mainImage.addEventListener('touchstart', e => { touchstartX = e.changedTouches[0].screenX; }, { passive: true });
        mainImage.addEventListener('touchend', e => { touchendX = e.changedTouches[0].screenX; handleGesture(); });

        // --- Scrollspy for navigation ---
        const sections = document.querySelectorAll('main section');
        const navLinks = document.querySelectorAll('.nav-link');
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    navLinks.forEach(link => {
                        link.classList.remove('active');
                        if (link.getAttribute('href').substring(1) === entry.target.id) {
                            link.classList.add('active');
                        }
                    });
                }
            });
        }, { threshold: 0.5 });
        sections.forEach(section => observer.observe(section));

        // --- Plan Cards Animation ---
        const planCards = document.querySelectorAll('.plan-card-vertical');
        const cardObserver = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('is-visible');
                    observer.unobserve(entry.target);
                }
            });
        }, { threshold: 0.2 });
        planCards.forEach(card => cardObserver.observe(card));

        // --- Three.js Logic ---
        const gltfLoader = new GLTFLoader();
        const clock = new THREE.Clock();

        // Main Scene
        let mainScene, mainCamera, mainRenderer, mainControls, mainModel;

        function init3D(container, onReady) {
            const scene = new THREE.Scene();
            scene.background = new THREE.Color(0xe4e4e7);

            const renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            container.appendChild(renderer.domElement);

            const environment = new RoomEnvironment(renderer);
            const pmremGenerator = new THREE.PMREMGenerator(renderer);
            scene.environment = pmremGenerator.fromScene(environment).texture;
            environment.dispose();

            const camera = new THREE.PerspectiveCamera(50, container.clientWidth / container.clientHeight, 0.1, 1000);
            camera.position.set(0, 0.5, 3);

            const controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;

            window.addEventListener('resize', () => {
                camera.aspect = container.clientWidth / container.clientHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(container.clientWidth, container.clientHeight);
            });

            onReady({ scene, camera, renderer, controls });
        }

        function loadModel(scene, url, callback) {
            const existingModel = scene.getObjectByName("loaded_model");
            if (existingModel) {
                scene.remove(existingModel);
            }
            if (!url) return;

            loader3D.style.display = 'flex';

            gltfLoader.load(url, (gltf) => {
                const model = gltf.scene;
                model.name = "loaded_model";

                const box = new THREE.Box3().setFromObject(model);
                const size = box.getSize(new THREE.Vector3()).length();
                const center = box.getCenter(new THREE.Vector3());

                model.position.x += (model.position.x - center.x);
                model.position.y += (model.position.y - center.y);
                model.position.z += (model.position.z - center.z);

                const camera = scene.userData.camera;
                const controls = scene.userData.controls;

                controls.reset();
                camera.position.copy(center);
                camera.position.x += size / 1.5;
                camera.position.y += size / 2.0;
                camera.position.z += size / 1.5;
                camera.lookAt(center);
                controls.target.copy(center);
                controls.update();

                scene.add(model);
                loader3D.style.display = 'none';
                if (callback) callback(model, gltf.animations);
            }, undefined, (error) => {
                console.error('An error happened while loading the model:', error);
                loader3D.textContent = 'Error al cargar modelo';
            });
        }

        // Fullscreen Modal Scene
        let modalScene, modalCamera, modalRenderer, modalControls, modalModel, modalMixer, modalGui, modalAnimationId;

        fullscreenBtn.addEventListener('click', () => {
            modal.classList.remove('hidden');
            modal.classList.add('flex');

            if (!modalRenderer) {
                init3D(modalViewerContainer, (components) => {
                    modalScene = components.scene;
                    modalCamera = components.camera;
                    modalRenderer = components.renderer;
                    modalControls = components.controls;
                    modalScene.userData = { camera: modalCamera, controls: modalControls };
                });
            }

            loadModel(modalScene, projects[currentProjectIndex].modelUrl, (model, animations) => {
                modalModel = model;
                setupModalGui(model, animations);
            });

            animateModal();
        });

        closeModalBtn.addEventListener('click', () => {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            if (modalGui) {
                modalGui.destroy();
                modalGui = null;
            }
            if (modalAnimationId) {
                cancelAnimationFrame(modalAnimationId);
                modalAnimationId = null;
            }
        });

        function setupModalGui(model, animations) {
            if (modalGui) modalGui.destroy();
            modalGui = new GUI();

            const params = { wireframe: false };
            modalGui.add(params, 'wireframe').name('Malla (Wireframe)').onChange((value) => {
                model.traverse((child) => {
                    if (child.isMesh) {
                        child.material.wireframe = value;
                    }
                });
            });

            if (animations && animations.length) {
                modalMixer = new THREE.AnimationMixer(model);
                const actions = {};
                animations.forEach(clip => {
                    actions[clip.name] = modalMixer.clipAction(clip);
                });

                const animParams = {
                    'Reproducir Todo': () => Object.values(actions).forEach(a => a.play()),
                    'Pausar Todo': () => Object.values(actions).forEach(a => a.stop()),
                };
                const animFolder = modalGui.addFolder('Animaciones');
                animFolder.add(animParams, 'Reproducir Todo');
                animFolder.add(animParams, 'Pausar Todo');
            }
        }

        function animateModal() {
            modalAnimationId = requestAnimationFrame(animateModal);
            const delta = clock.getDelta();
            if (modalMixer) modalMixer.update(delta);
            modalControls.update();
            modalRenderer.render(modalScene, modalCamera);
        }

        function animateMain() {
            requestAnimationFrame(animateMain);
            mainControls.update();
            mainRenderer.render(mainScene, mainCamera);
        }

        // --- Initial Load ---
        init3D(document.getElementById('viewer-3d-container'), (components) => {
            mainScene = components.scene;
            mainCamera = components.camera;
            mainRenderer = components.renderer;
            mainControls = components.controls;
            mainScene.userData = { camera: mainCamera, controls: mainControls };
            updatePortfolioView(currentProjectIndex);
            animateMain();
        });

    </script>

</body>
</html>
